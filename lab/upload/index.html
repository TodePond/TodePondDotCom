<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script
  data-goatcounter="https://todepond.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"></script>
<title>Tadi lab</title>
<link rel="shortcut icon" href="/favicon.png" />
<meta property="og:image" content="https://todepond.com/lab/og.png" />
<meta property="og:title" content="Tadi lab" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Tadi lab" />
<meta name="twitter:description" content="" />
<meta name="twitter:image" content="https://todepond.com/lab/og.png" />

<link rel="stylesheet" href="/style.css" />

<header>
  <h1>Upload</h1>

  <p>
    Feel free to upload images for use in other places, eg:
    <a href="https://pastagang.cc">pastagang</a>.
  </p>
  <p>
    All uploaded images are available at
    <code>https://tode.party?name</code><br />

    Replace <code>name</code> with the name you gave the image.
  </p>

  <p>
    <em>
      Please delete your uploads after you've finished with them to make space
      for others.<br />
      Uploads may be deleted at any time.
    </em>
  </p>
</header>

<style>
  header {
    /* max-width: 1000px; */
  }
  body {
    max-width: 100%;
  }

  code {
    white-space: nowrap;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 400px;
    align-items: flex-start;
  }

  label,
  section {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-color: var(--shade-4);
    border: 2px solid black;
  }

  label {
    padding: 16px;
  }

  section {
    padding: 16px;
    padding-top: 0px;
  }

  article {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
</style>

<form id="form">
  <label for="file">
    <img
      style="
        border: 1px solid rgb(159, 174, 238);
        width: 100%;
        background-color: rgb(55, 67, 98);
        height: 300px;
        object-fit: contain;
      "
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkAAIAAAoAAv/lPAAAAABJRU5ErkJggg=="
      alt="Preview of file upload"
      id="preview" />
    <input type="file" id="file" accept="image/*" required />
  </label>
  <label for="name">
    Unique upload name
    <input
      type="text"
      id="name"
      autocomplete="off"
      spellcheck="false"
      required />
  </label>
  <button class="primary" id="upload-button">Upload</button>
</form>

<br />

<h2>Uploaded files</h2>
<button id="refresh-button">Refresh</button>
<br />
<br />

<article id="uploads"></article>

<script type="module">
  const EMPTY_IMAGE =
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkAAIAAAoAAv/lPAAAAABJRU5ErkJggg==";
  const form = document.getElementById("form");
  const nameInput = document.getElementById("name");
  const fileInput = document.getElementById("file");
  const previewImage = document.getElementById("preview");
  const uploadButton = document.getElementById("upload-button");
  const refreshButton = document.getElementById("refresh-button");

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      previewImage.src = dataUrl;
    };
    reader.readAsDataURL(file);
  });

  form.addEventListener(
    "submit",
    async (event) => {
      event.preventDefault();
      const name = nameInput.value;
      const dataUrl = previewImage.src;
      const body = JSON.stringify({ name, dataUrl });
      uploadButton.disabled = true;
      uploadButton.textContent = "Uploading...";
      const response = await fetch(
        "https://todepond-labuploadupload.web.val.run",
        {
          method: "POST",
          body,
        }
      );
      const data = await response.json();
      if (data.ok) {
        nameInput.value = "";
        fileInput.value = "";
        previewImage.src = EMPTY_IMAGE;
      } else {
        alert(data.error);
      }
      uploadButton.textContent = "Upload";
      uploadButton.disabled = false;
      pullUploads();
    },
    { passive: false }
  );

  async function fetchUploads() {
    const response = await fetch(
      "https://todepond-labuploadgetuploads.web.val.run"
    );
    const data = await response.json();
    return data.rows;
  }

  async function pullUploads() {
    refreshButton.disabled = true;
    refreshButton.textContent = "Refreshing...";
    const uploads = await fetchUploads();
    renderUploads(uploads);
    refreshButton.textContent = "Refresh";
    refreshButton.disabled = false;
  }

  const uploadsElement = document.getElementById("uploads");
  function renderUploads(_uploads) {
    uploadsElement.innerHTML = "";

    const uploads = _uploads.reverse();

    for (const upload of uploads) {
      const uploadElement = document.createElement("section");
      uploadElement.className = "upload";
      // uploadElement.style.maxWidth = "400px";

      const nameElement = document.createElement("p");
      nameElement.textContent = upload.name;

      const imageElement = document.createElement("img");
      imageElement.src = `https://tode.party?${upload.name}`;
      imageElement.style.width = "100%";
      imageElement.style.objectFit = "contain";
      imageElement.style.border = "1px solid rgb(159, 174, 238)";
      imageElement.style.backgroundColor = "rgb(55, 67, 98)";
      imageElement.style.height = "300px";

      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Delete";
      deleteButton.className = "danger";
      deleteButton.addEventListener("click", async () => {
        deleteButton.disabled = true;
        deleteButton.textContent = "Deleting...";
        const response = await fetch(
          `https://todepond-labuploaddelete.web.val.run`,
          {
            method: "POST",
            body: JSON.stringify({ name: upload.name }),
          }
        );
        const data = await response.json();
        if (!data.ok) {
          alert(data.error);
        }
        deleteButton.textContent = "Delete";
        deleteButton.disabled = false;
        pullUploads();
      });

      uploadsElement.appendChild(uploadElement);
      uploadElement.appendChild(nameElement);
      uploadElement.appendChild(imageElement);
      uploadElement.appendChild(deleteButton);
    }
  }

  refreshButton.addEventListener("click", pullUploads);

  pullUploads();
</script>
